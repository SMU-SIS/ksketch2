<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009"
		xmlns:view="sg.edu.smu.ksketch2.canvas.components.view.*"
		xmlns:buttons="sg.edu.smu.ksketch2.canvas.components.buttons.*" 
		xmlns:s="library://ns.adobe.com/flex/spark" actionBarVisible="false" 
		xmlns:popup="sg.edu.smu.ksketch2.canvas.components.popup.*"
		viewActivate="viewActivateHandler(event)"
		>
	<fx:Script>
        
		<![CDATA[
			import flash.media.StageWebView;
			
			import spark.events.ViewNavigatorEvent;
			
			import air.net.URLMonitor;
			
			import sg.edu.smu.ksketch2.KSketchWebLinks;
			import sg.edu.smu.ksketch2.canvas.components.popup.KSketch_DataProgressBar;
			import sg.edu.smu.ksketch2.utils.KSketch_Preference;
			
			public static var userData:Object = new Object();
			
			private var progressTimer:Timer;
			private var _stageWidth:Number;
			private var _stageHeight:Number;
			private var _monitor:URLMonitor;
			private var _monitorTimer:Timer;
			private var _webView:StageWebView = new StageWebView();
			private var _isLoggedOut:Boolean = false;
			private var _token:String = "";
			
			protected function viewActivateHandler(event:ViewNavigatorEvent):void
			{
				data = null;
				_webView.stage = stage;
				_stageWidth = stage.stageWidth;
				_stageHeight = stage.stageHeight;
				
				if(_stageWidth > _stageHeight)
					_webView.viewPort = new Rectangle(0, 0, _stageWidth, _stageHeight);
				else
					_webView.viewPort = new Rectangle(0, 0, _stageHeight, _stageWidth);
				
				var fPath:String = new File(new File(KSketchWebLinks.localAgreement).nativePath).url; 
				
				try
				{
					_webView.loadURL( fPath);
					_webView.addEventListener(flash.events.LocationChangeEvent.LOCATION_CHANGE, locationChangedHandler);				//for IOS
					_webView.addEventListener(flash.events.LocationChangeEvent.LOCATION_CHANGING, locationChangingHandler);			//for ANDROID
					_webView.addEventListener(ErrorEvent.ERROR, errorEventHandler);
				}
				catch (err:Error) { trace(err); }
			}
			
			//FOR Android
			private function locationChangingHandler(event:LocationChangeEvent):void
			{
				var currentURL:String = event.location.toString();
				
				try
				{
					if((currentURL.indexOf(KSketchWebLinks.localAgreementAccept) >= 0))
						agree();
					else
						decline();
				}
				catch (err:Error) { trace(err); }
				
			}
			
			//FOR IOS
			private function locationChangedHandler(event:LocationChangeEvent):void
			{
				var currentURL:String = event.location.toString();
				
				try
				{
					if((currentURL.indexOf(KSketchWebLinks.localAgreementAccept) >= 0))
						agree();
					else
						decline();
					
				}
				catch (err:Error) { trace(err); }
			}
			
			private function decline():void
			{
				disposeView();
				NativeApplication.nativeApplication.exit();
			}
			
			private function agree():void
			{
				disposeView();
				KSketch_Preference.createPreferences();
				navigator.pushView(KSketch_HomeView);
			}
			
			private function disposeView():void
			{
				_webView.removeEventListener(ErrorEvent.ERROR, errorEventHandler);
				_webView.stop();
				_webView.viewPort = null;
				_webView.dispose();
				_webView = null;
			}
			
			private function errorEventHandler(event:ErrorEvent):void
			{
				trace("error handled: " + event);
			}
		]]>
	</fx:Script>
	<popup:DataProgressBar id="progressBar" skinClass="sg.edu.smu.ksketch2.canvas.components.popup.KSketch_DataProgressBar"
						   horizontalCenter="0" verticalCenter="0" visible="false"/>
</s:View>